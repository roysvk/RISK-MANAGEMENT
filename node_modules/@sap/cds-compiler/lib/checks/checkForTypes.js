'use strict';

const { isPersistedOnDatabase } = require('../model/csnUtils.js');

/**
 * Check that `cds.hana` types are not used - we don't support them for postgres
 *
 * @param {object} parent Object with a type
 * @param {string} name Name of the type property on parent
 * @param {Array} type type to check
 * @param {CSN.Path} path
 */
function checkForHanaTypes(parent, name, type, path) {
  const artifact = this.csn.definitions[path[1]];
  if (artifact.kind === 'entity' && isPersistedOnDatabase(artifact) && typeof parent.type === 'string' && parent.type.startsWith('cds.hana.'))
    this.error('ref-unexpected-hana-type', [ ...path, 'type' ], {}, `Types in the ”cds.hana“ namespace can't be used with sqlDialect “postgres”`);
}

/**
 * Check that `cds.UInt8`is not used - we don't have a clear idea how to represent it on postgres
 *
 * @param {object} parent Object with a type
 * @param {string} name Name of the type property on parent
 * @param {Array} type type to check
 * @param {CSN.Path} path
 */
function checkForUInt8(parent, name, type, path) {
  const artifact = this.csn.definitions[path[1]];
  if (artifact.kind === 'entity' && isPersistedOnDatabase(artifact) && parent.type === 'cds.UInt8')
    this.error('ref-unexpected-type', [ ...path, 'type' ], {}, `Type ”cds.UInt8“ can't be used with sqlDialect “postgres”`);
}

/**
 * Check types - specifically for postgres
 *
 * @param {object} parent Object with a type
 * @param {string} name Name of the type property on parent
 * @param {Array} type type to check
 * @param {CSN.Path} path
 */
function checkTypes(parent, name, type, path) {
  checkForHanaTypes.bind(this)(parent, name, type, path);
  checkForUInt8.bind(this)(parent, name, type, path);
}

module.exports = {
  type: checkTypes,
};
